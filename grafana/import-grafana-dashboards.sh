#!/bin/bash

# Script pour importer les dashboards Grafana personnalis√©s
# Utilisation: ./import-grafana-dashboards.sh

set -e

# Configuration
GRAFANA_URL="http://localhost:3000"
GRAFANA_USER="admin"
GRAFANA_PASSWORD="admin"

# Fonction pour importer un dashboard
import_dashboard() {
    local dashboard_file=$1
    local dashboard_name=$(basename "$dashboard_file" .json)

    echo "Importation du dashboard: $dashboard_name"

    # Cr√©er le payload pour l'API Grafana
    local payload=$(cat "$dashboard_file" | jq '.dashboard + {overwrite: true}')

    # Importer via API
    curl -s -X POST \
         -H "Content-Type: application/json" \
         -u "$GRAFANA_USER:$GRAFANA_PASSWORD" \
         -d "$payload" \
         "$GRAFANA_URL/api/dashboards/db" | jq -r '.status'

    echo "‚úÖ Dashboard $dashboard_name import√©"
}

# V√©rifier que Grafana est accessible
echo "V√©rification de la connexion √† Grafana..."
if ! curl -s -u "$GRAFANA_USER:$GRAFANA_PASSWORD" "$GRAFANA_URL/api/health" > /dev/null; then
    echo "‚ùå Erreur: Grafana n'est pas accessible √† $GRAFANA_URL"
    echo "   V√©rifiez que le port-forwarding est actif:"
    echo "   kubectl port-forward svc/grafana-service 3000:3000 -n default"
    exit 1
fi

echo "‚úÖ Grafana accessible"

# Importer les dashboards
echo "Importation des dashboards personnalis√©s..."

if [ -f "grafana-dashboards/scoring-ml-dashboard.json" ]; then
    import_dashboard "grafana-dashboards/scoring-ml-dashboard.json"
else
    echo "‚ö†Ô∏è  Dashboard ML non trouv√©: grafana-dashboards/scoring-ml-dashboard.json"
fi

if [ -f "grafana-dashboards/scoring-business-dashboard.json" ]; then
    import_dashboard "grafana-dashboards/scoring-business-dashboard.json"
else
    echo "‚ö†Ô∏è  Dashboard Business non trouv√©: grafana-dashboards/scoring-business-dashboard.json"
fi

echo ""
echo "üéâ Importation termin√©e!"
echo ""
echo "üìä Dashboards disponibles dans Grafana:"
echo "   - MLOps Scoring Platform - ML Metrics"
echo "   - MLOps Scoring Platform - Business Metrics"
echo ""
echo "üîó Acc√®s: http://localhost:3000 (admin/admin)"